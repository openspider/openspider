#!/usr/bin/env python3
"""
OpenSpiderä¸€é”®éƒ¨ç½²è„šæœ¬
è‡ªåŠ¨åˆ›å»ºGitHubä»“åº“å¹¶æ¨é€ä»£ç 

ä½¿ç”¨æ–¹æ³•:
    python3 deploy.py
    (è„šæœ¬ä¼šæç¤ºè¾“å…¥GitHubç”¨æˆ·åå’ŒToken)
"""

import os
import sys
import json
import base64
import subprocess
import hashlib
import time
from urllib.request import Request, urlopen
from urllib.error import URLError, HTTPError

# é…ç½®
REPO_NAME = "openspider"
REPO_DESC = "OpenSpider Plan - NRTç»„ç»‡å»ºè®¾æ–¹æ¡ˆ"
WORKSPACE = "/root/.openclaw/workspace"

def github_request(method, path, data=None, auth=None):
    """GitHub APIè¯·æ±‚"""
    url = f"https://api.github.com{path}"
    headers = {
        "Accept": "application/vnd.github.v3+json",
        "User-Agent": "OpenSpider-Deploy/1.0"
    }
    if auth:
        credentials = f"{auth[0]}:{auth[1]}"
        headers["Authorization"] = f"token {auth[1]}"
    
    try:
        req = Request(url, headers=headers, method=method)
        if data:
            req.data = json.dumps(data).encode()
        with urlopen(req) as response:
            return json.loads(response.read().decode())
    except HTTPError as e:
        body = e.read().decode()
        try:
            error = json.loads(body).get("message", str(e))
            raise Exception(error)
        except:
            raise Exception(str(e))
    except URLError as e:
        raise Exception(f"ç½‘ç»œé”™è¯¯: {e}")

def get_input(prompt, default=None):
    """å®‰å…¨çš„è¾“å…¥å‡½æ•°"""
    if default:
        result = input(f"{prompt} [{default}]: ").strip()
        return result or default
    return input(f"{prompt}: ").strip()

def deploy():
    print("\nğŸš€ OpenSpideréƒ¨ç½²è„šæœ¬")
    print("=" * 50)
    
    # 1. è·å–è®¤è¯ä¿¡æ¯
    print("\nğŸ“‹ ç¬¬1æ­¥: GitHubè®¤è¯")
    print("-" * 50)
    
    GITHUB_USER = os.environ.get("GITHUB_USER", "").strip()
    GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN", "").strip()
    
    if not GITHUB_USER:
        GITHUB_USER = get_input("è¯·è¾“å…¥GitHubç”¨æˆ·å")
    if not GITHUB_TOKEN:
        print("è¯·åˆ›å»ºPersonal Access Token:")
        print("  â†’ https://github.com/settings/tokens")
        print("  â†’ æƒé™: repo, admin:org")
        GITHUB_TOKEN = get_input("è¯·è¾“å…¥Token", "")
    
    if not GITHUB_TOKEN:
        print("\nâŒ é”™è¯¯: éœ€è¦GitHub Tokenæ‰èƒ½éƒ¨ç½²")
        sys.exit(1)
    
    print(f"\nâœ… è®¤è¯ä¿¡æ¯å·²é…ç½®")
    
    # 2. åˆ›å»ºä»“åº“
    print("\nğŸ“¦ ç¬¬2æ­¥: åˆ›å»ºGitHubä»“åº“")
    print("-" * 50)
    
    try:
        github_request("POST", "/user/repos", {
            "name": REPO_NAME,
            "description": REPO_DESC,
            "private": False,
            "auto_init": False
        }, auth=(GITHUB_USER, GITHUB_TOKEN))
        print(f"   âœ… ä»“åº“ {GITHUB_USER}/{REPO_NAME} åˆ›å»ºæˆåŠŸ")
    except Exception as e:
        if "already exists" in str(e).lower():
            print(f"   âš ï¸ ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")
        else:
            print(f"   âŒ åˆ›å»ºå¤±è´¥: {e}")
            sys.exit(1)
    
    # 3. é…ç½®Git
    print("\nâš™ï¸ ç¬¬3æ­¥: é…ç½®Git")
    print("-" * 50)
    
    os.chdir(WORKSPACE)
    subprocess.run(["git", "config", "user.email", "seeker@kai.com"], capture_output=True)
    subprocess.run(["git", "config", "user.name", "SeekerOfKai"], capture_output=True)
    
    # æ£€æŸ¥å¹¶è®¾ç½®remote
    result = subprocess.run(["git", "remote", "get-url", "origin"], capture_output=True, text=True)
    remote_url = result.stdout.strip()
    
    expected_url = f"https://{GITHUB_TOKEN}@github.com/{GITHUB_USER}/{REPO_NAME}.git"
    
    if result.returncode != 0 or remote_url != expected_url:
        subprocess.run(["git", "remote", "remove", "origin"], capture_output=True)
        subprocess.run(["git", "remote", "add", "origin", expected_url], capture_output=True)
    
    print("   âœ… Gité…ç½®å®Œæˆ")
    
    # 4. æäº¤ä»£ç 
    print("\nğŸ“ ç¬¬4æ­¥: æäº¤ä»£ç ")
    print("-" * 50)
    
    subprocess.run(["git", "add", "-A"], capture_output=True)
    result = subprocess.run(["git", "status", "--porcelain"], capture_output=True, text=True)
    
    if result.stdout.strip():
        subprocess.run(["git", "commit", "-m", """feat: OpenSpiderè®¡åˆ’åˆå§‹æäº¤

- NRTç»„ç»‡å»ºè®¾å®Œæ•´æ–¹æ¡ˆ
- å››å‘ä»»åŠ¡æ± ç­–åˆ’(ä¸œ/è¥¿/å—/åŒ—)
- æ›¹æ“ä»»åŠ¡æ± ç³»ç»Ÿ
- ä»»åŠ¡è·Ÿè¸ªä¸æ±‡æŠ¥æœºåˆ¶

Generated by SeekerOfKai"""], capture_output=True)
        print("   âœ… ä»£ç å·²æäº¤")
    else:
        print("   âš ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤")
    
    # 5. è·å–å½“å‰åˆ†æ”¯SHA
    print("\nğŸ”— ç¬¬5æ­¥: å‡†å¤‡æ¨é€")
    print("-" * 50)
    
    # è·å–æœ€æ–°commit SHA
    result = subprocess.run(
        ["git", "log", "-1", "--format=%H"],
        capture_output=True, text=True
    )
    commit_sha = result.stdout.strip()
    
    # 6. æ¨é€
    print("   ğŸš€ æ¨é€åˆ°GitHub...")
    result = subprocess.run(
        ["git", "push", "-u", "origin", "main", "--force"],
        capture_output=True, text=True
    )
    
    if result.returncode == 0:
        print("\n" + "=" * 50)
        print("âœ… éƒ¨ç½²å®Œæˆ!")
        print(f"\nğŸŒ ä»“åº“åœ°å€: https://github.com/{GITHUB_USER}/{REPO_NAME}")
        print(f"ğŸ“¦ åŒ…å«æ–‡ä»¶:")
        
        # åˆ—å‡ºæ‰€æœ‰mdæ–‡ä»¶
        for f in sorted(os.listdir(WORKSPACE)):
            if f.endswith('.md') or f.endswith('.js') or f.endswith('.sh'):
                if not f.startswith('.'):
                    print(f"   ğŸ“„ {f}")
        
        print()
    else:
        print(f"\nâŒ æ¨é€å¤±è´¥: {result.stderr}")
        print("\nğŸ’¡ æç¤º: å¯èƒ½éœ€è¦å…ˆæ‰§è¡Œ:")
        print(f"   git branch -M main")
        print(f"   git push -u origin main --force")
        sys.exit(1)

if __name__ == "__main__":
    deploy()
